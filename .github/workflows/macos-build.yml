name: macOS Build

on:
  push:
    branches: [ myGUI ]
  workflow_dispatch:

jobs:
  build-macos-x64:
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Bootstrap vcpkg
        run: |
          chmod +x ./vcpkg/bootstrap-vcpkg.sh
          ./vcpkg/bootstrap-vcpkg.sh

      - name: Install dependencies via vcpkg
        run: |
          ./vcpkg/vcpkg install raylib:x64-osx

      - name: Configure (Release, x64)
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=x64-osx \
            -DCMAKE_OSX_ARCHITECTURES=x86_64

      - name: Build
        run: cmake --build build --config Release -- -j$(sysctl -n hw.ncpu)

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist-mac
          # Expect single-config generator output at build/PersonalFinanceManager
          if [ -f "build/PersonalFinanceManager" ]; then
            cp build/PersonalFinanceManager dist-mac/PersonalFinanceManager-mac-x64
          else
            # Fallback search
            BIN=$(find build -type f -name "PersonalFinanceManager" | head -n 1)
            if [ -z "$BIN" ]; then
              echo "Executable not found" >&2
              exit 1
            fi
            cp "$BIN" dist-mac/PersonalFinanceManager-mac-x64
          fi
          (cd dist-mac && zip -r PersonalFinanceManager-mac-x64.zip PersonalFinanceManager-mac-x64)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PersonalFinanceManager-mac-x64
          path: dist-mac/PersonalFinanceManager-mac-x64.zip